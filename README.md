# proto-playground

In this playground we are gonna visit how to set up proto-lens and all its goodness. To get all the good stuff we are going to stick with `master` branch of `proto-lens`, so there is gonna be a few extra steps involved. If you want to follow along rather than pull the repo here are the steps.

## Setup

I am going to use `stack` and `hpack` to set things up. So heeeeerrrrrreeeee weeeeee go:

### 1. Create a new stack project

`stack new proto-playground simple-hpack && cd proto-playground`

### 2. Setup proto

Now we have our top level project we are going to create a `proto` package inside:
`stack new proto simple-hpack`

We will setup the stuff in the project first before coming back to `proto-playground`. In our `proto/src` directory we will remove `Main.hs` and replace it with a `person.proto` file with the following contents:

```protobuf
syntax="proto3";

message Person {
    string name = 1;
    int32 age = 2;

    // Address is a message defined somewhere else.
    repeated Address addresses = 3;
}

message Address {
  string street = 1;
  string zip_code = 2;
}
```

Next we will edit the `package.yaml` file to add in the things we need:

```yaml
name: person-proto

custom-setup:
  dependencies: base, Cabal, proto-lens-protoc

extra-source-files: src/**/*.proto

library:
  dependencies:
    - base
    - proto-lens
    - proto-lens-protoc
    - proto-lens-protobuf-types

  exposed-modules:
    - Proto.Person
    - Proto.Person'Fields
```

This will autogenerate two modules `Proto.Person` where our records will be defined and `Proto.Person'Fields` where our field accessors will be defined.

The last thing we need to do here is edit `Setup.hs` to have:

```haskell
import Data.ProtoLens.Setup

main = defaultMainGeneratingProtos "src"
```

### 3. Setup proto-playground

Here we are going to be telling `proto-playground` how to find the proto stuff we just setup and how to grab the most up to date version of `proto-lens`. First thing to do will be to edit the `stack.yaml` file as follows:

1. Under `packages` we should have:

```yaml
packages:
- .
- proto
```

2. Under `packages` we will add a new field:

```yaml
- extra-dep: true
  location:
    git: https://github.com/google/proto-lens
    commit: master
  subdirs:
    - proto-lens
    - proto-lens-protobuf-types
    - proto-lens-protoc
    - lens-labels
```

This last one says we will grab `proto-lens` from the github repo and use the `master` commit. It is better practice to clamp this to a certain commit in real projects.

Our final step will be to add `person-proto`, along with `default-data`, `microlens`, and `proto-lens`, to our dependencies in our main project like so:

```yaml
name:                proto-playgorund
version:             0.1.0.0
#synopsis:
#description:
homepage:            https://github.com/githubuser/proto-playground#readme
license:             BSD3
author:              Author name here
maintainer:          example@example.com
copyright:           2017 Author name here
category:            Web
extra-source-files:
- README.md

dependencies:
  - base >= 4.7 && < 5
  - person-proto
  - data-default
  - microlens
  - proto-lens

executables:
  proto-wtf:
    source-dirs:      src
    main:             Main.hs
```

Alright! Let us test this puppy out! We will make a `Main.hs` in our main project so we can create and print some stuff out!

```haskell
{-# LANGUAGE OverloadedStrings #-}

module Main where

import Proto.Person as P
import Proto.Person'Fields as P
import Data.Default
import Data.ProtoLens (showMessage)
import Lens.Micro

person :: P.Person
person =
  def & P.name      .~ "Fintan"
      & P.age       .~ 24
      & P.addresses .~ [address]
  where
    address :: P.Address
    address =
      def & P.street  .~ "Yolo street"
          & P.zipCode .~ "D8"


main :: IO ()
main = do
  putStrLn . showMessage $ person
```

### Troubleshooting

You may run into issues with not being able to find names and what not when trying to run `stack build`. If this is occurring then try do a `stack clean --full` and try `stack build` again.

### Finding autogenerated files

The autogenerated files will be located in your `proto` directories `.stack-work`. If you want inspect any of the files you can open them open :)

To find the ones we create you can run:
`find . -name Person.hs`
